<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32_Website</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Debug Options/Settings</h1>
    <a class="dev" href="index.html">Return</a>
    <div class="main">
        <form action="changeUserInfos" method="post">
            <fieldset>
                <legend>Login</legend>
                <table>
                    <tr>
                        <td>Benutzername:</td>
                        <td><input type="text" name="newUserName" value="{USERNAME}"></td>
                    </tr>
                    <tr>
                        <td>Passwort:</td>
                        <td><input type="password" name="newUserPWD" value="{USERPSW}"></td>
                    </tr>
                </table>
                <br>
                <div class="flex">
                    <input type="submit" value="Speichern">
                    <input type="reset" value="Zurücksetzen">
                </div>
                
            </fieldset>
        </form>
        <script>

            async function updateLogs() {
                try {
                    const res = await fetch("/api/logs");
                    const text = await res.text();
                    document.getElementById("logs").innerText = text;
                } catch (e) {
                    console.log("Log update error:", e);
                }
            }
            
            async function executeFunction(id) {
                try {

                    if (id === 3) {
                        const ok = confirm(
                            "⚠️ Achtung!\n\n" +
                            "Alle Konfigurationen werden gelöscht. Inclusive der Api-Keys!\n Diese Müssen im Anschluss manuell neu hochgeladen werden!\n" +
                            "Das Gerät startet danach neu.\n\n" +
                            "Fortfahren?"
                        );
                        if (!ok) return;
                    }

                    let url = null;

                    switch (id) {
                        case 0:
                            url = "api/restartWlan";
                            break;
                        case 1:
                            url = "api/restartDisplay";
                            break;
                        case 2:
                            url = "api/restartESP";
                            break;
                        case 3:
                            url = "api/resetConfigs";
                            break;
                        default:
                            console.warn("Unknown function id:", id);
                            return;
                    }

                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error("Request failed: " + response.status);
                    }

                } catch (e) {
                    console.error("Execute function error:", e);
                }
            }

            async function updateInfos() {
                try {
                    const res = await fetch("/api/infos");
                    const text = await res.text();
                    var parts = text.split("; ");

                    for(var i = 0; i < parts.length; i++){
                        var partName = parts[i].split("=")[0];
                        var partValue = parts[i].split("=")[1];
                        document.getElementById(partName).innerHTML = partValue;
                    }

                } catch (e) {
                    console.log("Infos update error:", e);
                }
            }

            // update every 3 seconds
            setInterval(updateLogs, 5000);
            setInterval(updateInfos, 1000);

            // first load immediately
            updateLogs();
            updateInfos();



        </script>

        <fieldset>
            <legend>System Infos</legend>
            <table>
                <tr>
                    <td>Uptime:</td>
                    <td><p id="UPTIME"></p></td>
                </tr>
                <tr>
                    <td>Wifi status:</td>
                    <td><p id="WIFISTATUS"></p></td>
                </tr>
                <tr>
                    <td>IP-address</td>
                    <td><p id="IPADDRESS"></p></td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend>Sensors</legend>
            <table>
                <tr>
                    <td>Last Successful Connection:</td>
                    <td><p id="LAST_CONNECTION"></p></td>
                </tr>
                <tr>
                    <td>Last API call</td>
                    <td><p id="LAST_API_CALL"></p></td>
                </tr>
            </table>
        </fieldset>
        <fieldset>
            <legend>Actions</legend>
            <table class="equalSize">
                <tr>
                    <td><input type="button" value="Connect Wifi" onclick="executeFunction(0)"></td>
                    <td><input type="button" value="Restart" onclick="executeFunction(2)"></td>
                </tr>
                <tr>
                    <td><input type="button" value="Restart Display" onclick="executeFunction(1)"></td>
                    <td><input type="button" value="Reset Konfiguration" onclick="executeFunction(3)"></td>
                </tr>
            </table>
        </fieldset>

        <fieldset>
            <legend>Statistiken</legend>
            <table>
                <tr>
                    <td>Arbeitszeit:</td>
                    <td>1 Monat, 9 Tage</td>
                </tr>
                <tr>
                    <td>Code Zeilen hinzugefügt:</td>
                    <td>4962</td>
                </tr>
                <tr>
                    <td>Code Zeilen gelöscht:</td>
                    <td>1416</td>
                </tr>
                <tr>
                    <td>Verwendete Sprachen:</td>
                    <td>5: C++, C, HTML, Javascript, CSS</td>
                </tr>
                <tr>
                    <td>Insgesammte Dateien:</td>
                    <td>26</td>
                </tr>
            </table>
        </fieldset>

        <fieldset>
            <legend>Logs</legend>
            <p class="logs" id="logs"></p>
        </fieldset>



    </div>

    
</body>
</html>